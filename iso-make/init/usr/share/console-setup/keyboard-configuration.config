#!/bin/sh
set -e
. /usr/share/debconf/confmodule
CONFIGFILE=/etc/default/keyboard
OLDCONFIGFILE=/etc/default/console-setup
default_toggle=''
default_switch=''
default_altgr=''
default_compose=''
default_layout=''
default_variant=''
XKBMODEL=''
XKBLAYOUT=''
XKBVARIANT=''
XKBOPTIONS=''
if [ -f /usr/share/console-setup/keyboard-configuration.config ]; then
is_debian_installer=yes
is_not_debian_installer=''
else
is_debian_installer=''
is_not_debian_installer=yes
fi
all_kbdnames () {
cat <<'EOF' 
C*layout*fr*K
C*variant*fr**K
C*variant*fr*bepo_latin9*K
C*variant*fr*oss*K
C*variant*fr*latin9_nodeadkeys*K
C*variant*fr*latin9_sundeadkeys*K
C*variant*fr*oss_sundeadkeys*K
C*variant*fr*bepo*K
C*variant*fr*mac*K
C*variant*fr*nodeadkeys*K
C*variant*fr*oss_latin9*K
C*variant*fr*oss_nodeadkeys*K
C*variant*fr*bre*K
C*variant*fr*sundeadkeys*K
C*variant*fr*dvorak*K
C*variant*fr*geo*K
C*variant*fr*oci*K
C*variant*fr*latin9*K
C*layout*uz*K
C*variant*uz**K
C*variant*uz*latin*K
C*layout*tw*K
C*variant*tw**K
C*variant*tw*indigenous*K
C*variant*tw*saisiyat*K
C*layout*tz*K
C*variant*tz**K
C*layout*za*K
C*variant*za**K
C*layout*gr*K
C*variant*gr**K
C*variant*gr*extended*K
C*variant*gr*polytonic*K
C*variant*gr*simple*K
C*variant*gr*nodeadkeys*K
C*layout*in*K
C*variant*in**K
C*variant*in*ben_bornona*K
C*variant*in*guj*K
C*variant*in*guru*K
C*variant*in*kan*K
C*variant*in*ben_baishakhi*K
C*variant*in*eng*K
C*variant*in*urd-winkeys*K
C*variant*in*mal*K
C*variant*in*jhelum*K
C*variant*in*mal_enhanced*K
C*variant*in*tam_TSCII*K
C*variant*in*tam_unicode*K
C*variant*in*tam*K
C*variant*in*bolnagri*K
C*variant*in*ben_probhat*K
C*variant*in*ben_inscript*K
C*variant*in*hin-wx*K
C*variant*in*ben*K
C*variant*in*ben_gitanjali*K
C*variant*in*tam_TAB*K
C*variant*in*tam_keyboard_with_numerals*K
C*variant*in*mal_lalitha*K
C*variant*in*tel*K
C*variant*in*urd-phonetic3*K
C*variant*in*ori*K
C*variant*in*urd-phonetic*K
C*layout*lt*K
C*variant*lt**K
C*variant*lt*std*K
C*variant*lt*lekp*K
C*variant*lt*ibm*K
C*variant*lt*us*K
C*variant*lt*lekpa*K
C*layout*gn*K
C*variant*gn**K
C*layout*cd*K
C*variant*cd**K
C*layout*cn*K
C*variant*cn**K
C*variant*cn*tib_asciinum*K
C*variant*cn*uig*K
C*variant*cn*tib*K
C*layout*kg*K
C*variant*kg**K
C*variant*kg*phonetic*K
C*layout*ml*K
C*variant*ml**K
C*variant*ml*fr-oss*K
C*variant*ml*us-mac*K
C*variant*ml*us-intl*K
C*layout*ge*K
C*variant*ge**K
C*variant*ge*ergonomic*K
C*variant*ge*os*K
C*variant*ge*ru*K
C*variant*ge*mess*K
C*layout*cm*K
C*variant*cm**K
C*variant*cm*french*K
C*variant*cm*qwerty*K
C*variant*cm*dvorak*K
C*variant*cm*azerty*K
C*layout*mao*K
C*variant*mao**K
C*layout*gb*K
C*variant*gb**K
C*variant*gb*extd*K
C*variant*gb*mac*K
C*variant*gb*dvorakukp*K
C*variant*gb*dvorak*K
C*variant*gb*intl*K
C*variant*gb*mac_intl*K
C*variant*gb*colemak*K
C*layout*bd*K
C*variant*bd**K
C*variant*bd*probhat*K
C*layout*de*K
C*variant*de**K
C*variant*de*nodeadkeys*K
C*variant*de*deadacute*K
C*variant*de*sundeadkeys*K
C*variant*de*mac*K
C*variant*de*deadgraveacute*K
C*variant*de*ru*K
C*variant*de*mac_nodeadkeys*K
C*variant*de*dsb*K
C*variant*de*ro_nodeadkeys*K
C*variant*de*ro*K
C*variant*de*dvorak*K
C*variant*de*dsb_qwertz*K
C*variant*de*neo*K
C*layout*ro*K
C*variant*ro**K
C*variant*ro*winkeys*K
C*variant*ro*std_cedilla*K
C*variant*ro*std*K
C*variant*ro*cedilla*K
C*layout*mt*K
C*variant*mt**K
C*variant*mt*us*K
C*layout*th*K
C*variant*th**K
C*variant*th*pat*K
C*variant*th*tis*K
C*layout*ie*K
C*variant*ie**K
C*variant*ie*ogam_is434*K
C*variant*ie*CloGaelach*K
C*variant*ie*UnicodeExpert*K
C*variant*ie*ogam*K
C*layout*ir*K
C*variant*ir**K
C*variant*ir*ku_ara*K
C*variant*ir*ku_f*K
C*variant*ir*pes_keypad*K
C*variant*ir*ku_alt*K
C*variant*ir*ku*K
C*layout*mv*K
C*variant*mv**K
C*layout*latam*K
C*variant*latam**K
C*variant*latam*sundeadkeys*K
C*variant*latam*nodeadkeys*K
C*variant*latam*deadtilde*K
C*layout*mm*K
C*variant*mm**K
C*layout*vn*K
C*variant*vn**K
C*layout*ch*K
C*variant*ch**K
C*variant*ch*de_nodeadkeys*K
C*variant*ch*de_sundeadkeys*K
C*variant*ch*fr_sundeadkeys*K
C*variant*ch*fr_mac*K
C*variant*ch*de_mac*K
C*variant*ch*fr_nodeadkeys*K
C*variant*ch*fr*K
C*variant*ch*legacy*K
C*layout*pl*K
C*variant*pl**K
C*variant*pl*dvorak*K
C*variant*pl*csb*K
C*variant*pl*qwertz*K
C*variant*pl*dvorak_quotes*K
C*variant*pl*ru_phonetic_dvorak*K
C*variant*pl*dvorak_altquotes*K
C*variant*pl*dvp*K
C*layout*tr*K
C*variant*tr**K
C*variant*tr*sundeadkeys*K
C*variant*tr*ku_f*K
C*variant*tr*alt*K
C*variant*tr*crh_alt*K
C*variant*tr*intl*K
C*variant*tr*f*K
C*variant*tr*crh*K
C*variant*tr*ku*K
C*variant*tr*crh_f*K
C*variant*tr*ku_alt*K
C*layout*sy*K
C*variant*sy**K
C*variant*sy*syc_phonetic*K
C*variant*sy*syc*K
C*variant*sy*ku*K
C*variant*sy*ku_f*K
C*variant*sy*ku_alt*K
C*layout*hr*K
C*variant*hr**K
C*variant*hr*unicode*K
C*variant*hr*alternatequotes*K
C*variant*hr*unicodeus*K
C*variant*hr*us*K
C*layout*tj*K
C*variant*tj**K
C*variant*tj*legacy*K
C*layout*hu*K
C*variant*hu**K
C*variant*hu*101_qwertz_comma_nodead*K
C*variant*hu*standard*K
C*variant*hu*102_qwertz_dot_nodead*K
C*variant*hu*102_qwertz_dot_dead*K
C*variant*hu*102_qwertz_comma_dead*K
C*variant*hu*102_qwerty_comma_nodead*K
C*variant*hu*102_qwertz_comma_nodead*K
C*variant*hu*101_qwerty_comma_dead*K
C*variant*hu*101_qwerty_dot_dead*K
C*variant*hu*101_qwertz_dot_nodead*K
C*variant*hu*101_qwertz_comma_dead*K
C*variant*hu*102_qwerty_dot_nodead*K
C*variant*hu*101_qwertz_dot_dead*K
C*variant*hu*qwerty*K
C*variant*hu*102_qwerty_dot_dead*K
C*variant*hu*nodeadkeys*K
C*variant*hu*101_qwerty_dot_nodead*K
C*variant*hu*101_qwerty_comma_nodead*K
C*variant*hu*102_qwerty_comma_dead*K
C*layout*am*K
C*variant*am**K
C*variant*am*phonetic*K
C*variant*am*eastern*K
C*variant*am*eastern-alt*K
C*variant*am*phonetic-alt*K
C*variant*am*western*K
C*layout*sn*K
C*variant*sn**K
C*layout*cz*K
C*variant*cz**K
C*variant*cz*qwerty*K
C*variant*cz*dvorak-ucw*K
C*variant*cz*bksl*K
C*variant*cz*ucw*K
C*variant*cz*qwerty_bksl*K
C*layout*al*K
C*variant*al**K
C*layout*mk*K
C*variant*mk**K
C*variant*mk*nodeadkeys*K
C*layout*bg*K
C*variant*bg**K
C*variant*bg*bas_phonetic*K
C*variant*bg*phonetic*K
C*layout*bt*K
C*variant*bt**K
C*layout*rs*K
C*variant*rs**K
C*variant*rs*latinunicodeyz*K
C*variant*rs*latinunicode*K
C*variant*rs*alternatequotes*K
C*variant*rs*latin*K
C*variant*rs*rue*K
C*variant*rs*latinalternatequotes*K
C*variant*rs*latinyz*K
C*variant*rs*yz*K
C*layout*af*K
C*variant*af**K
C*variant*af*uz*K
C*variant*af*olpc-ps*K
C*variant*af*uz-olpc*K
C*variant*af*ps*K
C*variant*af*fa-olpc*K
C*layout*ng*K
C*variant*ng**K
C*variant*ng*igbo*K
C*variant*ng*yoruba*K
C*variant*ng*hausa*K
C*layout*la*K
C*variant*la**K
C*variant*la*stea*K
C*layout*pk*K
C*variant*pk**K
C*variant*pk*urd-nla*K
C*variant*pk*ara*K
C*variant*pk*urd-crulp*K
C*variant*pk*snd*K
C*layout*lv*K
C*variant*lv**K
C*variant*lv*adapted*K
C*variant*lv*tilde*K
C*variant*lv*ergonomic*K
C*variant*lv*fkey*K
C*variant*lv*modern*K
C*variant*lv*apostrophe*K
C*layout*fo*K
C*variant*fo**K
C*variant*fo*nodeadkeys*K
C*layout*ru*K
C*variant*ru**K
C*variant*ru*typewriter-legacy*K
C*variant*ru*phonetic_winkeys*K
C*variant*ru*os_legacy*K
C*variant*ru*chm*K
C*variant*ru*srp*K
C*variant*ru*udm*K
C*variant*ru*typewriter*K
C*variant*ru*os_winkeys*K
C*variant*ru*legacy*K
C*variant*ru*kom*K
C*variant*ru*cv*K
C*variant*ru*xal*K
C*variant*ru*phonetic*K
C*variant*ru*bak*K
C*variant*ru*cv_latin*K
C*variant*ru*dos*K
C*variant*ru*sah*K
C*variant*ru*tt*K
C*layout*br*K
C*variant*br**K
C*variant*br*nativo*K
C*variant*br*nativo-us*K
C*variant*br*nativo-epo*K
C*variant*br*dvorak*K
C*variant*br*nodeadkeys*K
C*layout*no*K
C*variant*no**K
C*variant*no*mac_nodeadkeys*K
C*variant*no*smi_nodeadkeys*K
C*variant*no*smi*K
C*variant*no*dvorak*K
C*variant*no*mac*K
C*variant*no*nodeadkeys*K
C*layout*me*K
C*variant*me**K
C*variant*me*cyrillic*K
C*variant*me*latinalternatequotes*K
C*variant*me*latinunicode*K
C*variant*me*latinyz*K
C*variant*me*latinunicodeyz*K
C*variant*me*cyrillicyz*K
C*variant*me*cyrillicalternatequotes*K
C*layout*gh*K
C*variant*gh**K
C*variant*gh*avn*K
C*variant*gh*hausa*K
C*variant*gh*ewe*K
C*variant*gh*generic*K
C*variant*gh*ga*K
C*variant*gh*gillbt*K
C*variant*gh*fula*K
C*variant*gh*akan*K
C*layout*pt*K
C*variant*pt**K
C*variant*pt*mac_sundeadkeys*K
C*variant*pt*nativo-us*K
C*variant*pt*nativo-epo*K
C*variant*pt*sundeadkeys*K
C*variant*pt*mac_nodeadkeys*K
C*variant*pt*mac*K
C*variant*pt*nodeadkeys*K
C*variant*pt*nativo*K
C*layout*se*K
C*variant*se**K
C*variant*se*svdvorak*K
C*variant*se*swl*K
C*variant*se*nodeadkeys*K
C*variant*se*mac*K
C*variant*se*dvorak*K
C*variant*se*rus_nodeadkeys*K
C*variant*se*rus*K
C*variant*se*smi*K
C*layout*ara*K
C*variant*ara**K
C*variant*ara*qwerty_digits*K
C*variant*ara*azerty_digits*K
C*variant*ara*buckwalter*K
C*variant*ara*azerty*K
C*variant*ara*qwerty*K
C*variant*ara*digits*K
C*layout*az*K
C*variant*az**K
C*variant*az*cyrillic*K
C*layout*dk*K
C*variant*dk**K
C*variant*dk*dvorak*K
C*variant*dk*nodeadkeys*K
C*variant*dk*mac*K
C*variant*dk*mac_nodeadkeys*K
C*layout*epo*K
C*variant*epo**K
C*variant*epo*legacy*K
C*layout*ua*K
C*variant*ua**K
C*variant*ua*winkeys*K
C*variant*ua*rstu_ru*K
C*variant*ua*phonetic*K
C*variant*ua*legacy*K
C*variant*ua*rstu*K
C*variant*ua*homophonic*K
C*variant*ua*typewriter*K
C*layout*iq*K
C*variant*iq**K
C*variant*iq*ku_alt*K
C*variant*iq*ku*K
C*variant*iq*ku_f*K
C*variant*iq*ku_ara*K
C*layout*us*K
C*variant*us**K
C*variant*us*dvorak-l*K
C*variant*us*altgr-intl*K
C*variant*us*dvorak-r*K
C*variant*us*euro*K
C*variant*us*dvorak*K
C*variant*us*dvorak-alt-intl*K
C*variant*us*alt-intl*K
C*variant*us*mac*K
C*variant*us*dvp*K
C*variant*us*hbs*K
C*variant*us*colemak*K
C*variant*us*olpc2*K
C*variant*us*intl*K
C*variant*us*dvorak-classic*K
C*variant*us*dvorak-intl*K
C*variant*us*rus*K
C*variant*us*chr*K
C*layout*sk*K
C*variant*sk**K
C*variant*sk*bksl*K
C*variant*sk*qwerty_bksl*K
C*variant*sk*qwerty*K
C*layout*be*K
C*variant*be**K
C*variant*be*oss_latin9*K
C*variant*be*oss*K
C*variant*be*wang*K
C*variant*be*iso-alternate*K
C*variant*be*oss_sundeadkeys*K
C*variant*be*nodeadkeys*K
C*variant*be*sundeadkeys*K
C*layout*ee*K
C*variant*ee**K
C*variant*ee*nodeadkeys*K
C*variant*ee*us*K
C*variant*ee*dvorak*K
C*layout*il*K
C*variant*il**K
C*variant*il*phonetic*K
C*variant*il*lyx*K
C*variant*il*biblical*K
C*layout*et*K
C*variant*et**K
C*layout*kr*K
C*variant*kr**K
C*variant*kr*kr104*K
C*layout*mn*K
C*variant*mn**K
C*layout*si*K
C*variant*si**K
C*variant*si*us*K
C*variant*si*alternatequotes*K
C*layout*es*K
C*variant*es**K
C*variant*es*nodeadkeys*K
C*variant*es*sundeadkeys*K
C*variant*es*dvorak*K
C*variant*es*mac*K
C*variant*es*cat*K
C*variant*es*deadtilde*K
C*variant*es*ast*K
C*layout*jp*K
C*variant*jp**K
C*variant*jp*kana86*K
C*variant*jp*mac*K
C*variant*jp*kana*K
C*variant*jp*OADG109A*K
C*layout*nec_vndr/jp*K
C*variant*nec_vndr/jp**K
C*layout*kh*K
C*variant*kh**K
C*layout*brai*K
C*variant*brai**K
C*variant*brai*right_hand*K
C*variant*brai*left_hand*K
C*layout*ba*K
C*variant*ba**K
C*variant*ba*unicodeus*K
C*variant*ba*us*K
C*variant*ba*unicode*K
C*variant*ba*alternatequotes*K
C*layout*is*K
C*variant*is**K
C*variant*is*nodeadkeys*K
C*variant*is*mac*K
C*variant*is*dvorak*K
C*variant*is*Sundeadkeys*K
C*layout*fi*K
C*variant*fi**K
C*variant*fi*nodeadkeys*K
C*variant*fi*classic*K
C*variant*fi*smi*K
C*variant*fi*mac*K
C*layout*kz*K
C*variant*kz**K
C*variant*kz*ruskaz*K
C*variant*kz*kazrus*K
C*layout*ad*K
C*variant*ad**K
C*layout*ph*K
C*variant*ph**K
C*variant*ph*dvorak-bay*K
C*variant*ph*qwerty-bay*K
C*variant*ph*colemak*K
C*variant*ph*dvorak*K
C*variant*ph*capewell-qwerf2k6-bay*K
C*variant*ph*capewell-dvorak-bay*K
C*variant*ph*capewell-qwerf2k6*K
C*variant*ph*colemak-bay*K
C*variant*ph*capewell-dvorak*K
C*layout*tm*K
C*variant*tm**K
C*variant*tm*alt*K
C*layout*ke*K
C*variant*ke**K
C*variant*ke*kik*K
C*layout*ma*K
C*variant*ma**K
C*variant*ma*tifinagh-extended*K
C*variant*ma*tifinagh-alt-phonetic*K
C*variant*ma*tifinagh-phonetic*K
C*variant*ma*french*K
C*variant*ma*tifinagh*K
C*variant*ma*tifinagh-extended-phonetic*K
C*variant*ma*tifinagh-alt*K
C*layout*at*K
C*variant*at**K
C*variant*at*nodeadkeys*K
C*variant*at*sundeadkeys*K
C*variant*at*mac*K
C*layout*nl*K
C*variant*nl**K
C*variant*nl*mac*K
C*variant*nl*std*K
C*variant*nl*sundeadkeys*K
C*layout*bw*K
C*variant*bw**K
C*layout*ca*K
C*variant*ca**K
C*variant*ca*multi*K
C*variant*ca*multi-2gr*K
C*variant*ca*fr-legacy*K
C*variant*ca*eng*K
C*variant*ca*fr-dvorak*K
C*variant*ca*ike*K
C*variant*ca*multix*K
C*layout*lk*K
C*variant*lk**K
C*variant*lk*tam_unicode*K
C*variant*lk*tam_TAB*K
C*layout*np*K
C*variant*np**K
C*layout*by*K
C*variant*by**K
C*variant*by*legacy*K
C*variant*by*latin*K
C*layout*it*K
C*variant*it**K
C*variant*it*mac*K
C*variant*it*nodeadkeys*K
C*variant*it*us*K
C*variant*it*geo*K
EOF
[ ! -f /usr/share/console-setup/kbdnames.gz ] || zcat /usr/share/console-setup/kbdnames.gz 
}
db_capb backup
db_default () {
db_get keyboard-configuration/store_defaults_in_debconf_db
if [ "$RET" = true ]; then
db_set $1 "$2"
fi
}
regex_escape () {
sed \
-e 's/[.]/%period%/g' \
-e 's/\[/%lbracket%/g' \
-e 's/\]/%rbracket%/g' \
-e 's/\^/%caret%/g' \
-e 's/\$/%dollar%/g' \
-e 's/\\/%bslash%/g' \
-e 's/[/]/%slash%/g' \
-e 's/[?]/%question%/g' \
-e 's/[+]/%plus%/g'
}
regex_pattern_escape () {
sed \
-e 's/[.]/%period%/g' \
-e 's/\[/%lbracket%/g' \
-e 's/\]/%rbracket%/g' \
-e 's/\^/%caret%/g' \
-e 's/\$/%dollar%/g' \
-e 's/\\/%bslash%/g' \
-e 's/[/]/%slash%/g' \
-e 's/[?]/%question%/g' \
-e 's/[+]/%plus%/g' \
-e 's/[*]/\\*/g'
}
regex_unescape () {
sed \
-e 's/%period%/./g' \
-e 's/%lbracket%/[/g' \
-e 's/%rbracket%/]/g' \
-e 's/%caret%/^/g' \
-e 's/%dollar%/$/g' \
-e 's/%bslash%/\\/g' \
-e 's/%slash%/\//g' \
-e 's/%question%/?/g' \
-e 's/%plus%/+/g'
}
ask_debconf () {
local template priority prefix default_code default_description choices add
template="$1"
priority="$2"
prefix="$(echo "$3"|regex_pattern_escape)"
default_code="$(echo "$4"|regex_pattern_escape)"
add="$(echo "$5"|regex_escape)"
add="
$add"
choices1=`echo "$kbdnames" | grep "^$prefix\*" | 
sed -e "s/^$prefix\*[^\*]*\*//" -e 's/,/\\\\,/g' | sort`
choices2=`echo "$add" | grep "^$prefix\*" | 
sed -e "s/^$prefix\*[^\*]*\*//" -e 's/,/\\\\,/g'`
choices=`echo "$choices1
$choices2" | sed -e 's/$/,/'`
choices=`echo $choices | sed 's/, *$//' | regex_unescape`
choices=`echo $choices | sed 's/,$//'`
if echo "$choices" | grep '[^\\\\],' >/dev/null; then
db_subst $template CHOICES "$choices"
default_description=`echo "$kbdnames$add" |  
grep "^$prefix\*${default_code}\*" |
sed -e "s/^$prefix\*${default_code}\*//" |
regex_unescape`
if [ -z "$default_description" ]; then
default_description=`echo "$kbdnames$add" |  
grep "^$prefix\*\*" |
sed -e "s/^$prefix\*\*//" |
regex_unescape `
fi
if [ -n "$default_description" ]; then
db_default $template "$default_description"
elif [ -n "$default_code" ]; then
priority=critical
fi
db_input $priority $template || true
db_go || return 255
db_get $template
else
[ $STATE -gt $old_state ] || return 255
RET=$(echo "$choices"|sed 's/ *$//')
fi
RET=`echo "$RET" | regex_pattern_escape`
RET=`echo "$kbdnames$add" | grep "^$prefix\*[^\*]*\*" |
sed 's/  */ /g' |
grep "\*$RET\$" |
sed -e "s/^$prefix\*\([^\*]*\)\*.*/\1/" |
regex_unescape`
return 0
}
guess_arch () {
local arch subarch line
if type archdetect 2>/dev/null >/dev/null; then
archdetect
return 0
fi
arch=`dpkg --print-architecture`
if [ "$arch" = 'powerpc' -o "$arch" = 'm68k' ]; then
if [ "$arch" = powerpc ]; then
line=`sed -n 's/^platform.*: *//p' /proc/cpuinfo`
if [ "$line" = PS3 ] || [ "$line" = Cell ]; then
subarch=`echo $line|tr A-Z a-z`
else
line=`sed -n 's/^machine.*: *//p' /proc/cpuinfo`
if [ "$line" = '' ]; then
echo unknown
return 0
fi
subarch=`echo $line|tr A-Z a-z`
fi
elif [ "$arch" = m68k ]; then
line=`sed -n 's/^Model.*: *//p' /proc/hardware`
if [ "$line" = '' ]; then
echo unknown
return 0
fi
subarch=`echo $line|tr A-Z a-z`
fi
case "$subarch" in
*amiga*)
subarch=amiga
;;
*chrp*)
subarch=chrp
;;
*prep*)
subarch=prep
;;
*macintosh*|*powermac*|*powerbook*|*power*|*imac*|*powermac1*)
subarch=mac
;;
*atari*)
subarch=atari
;;
*motorola*)
subarch=mvme
;;
*bvme*)
subarch=bvme
;;
*)
subarch=`echo $subarch|sed  's/^\s*//'`
;;
esac
arch="$arch/$subarch"
fi
echo $arch
return 0
}
keyboard_present () {
local kern kbdpattern class subclass protocol
kern=`uname -r`
case "$kern" in
1*|2.0*|2.1*|2.2*|2.3*|2.4*|2.5*)
return 0; 
;;
esac
[ -f /proc/bus/input/devices ] || return 0
kbdpattern="AT Set \|AT Translated Set\|AT Raw Set"
kbdpattern="$kbdpattern\|Atari Keyboard"
kbdpattern="$kbdpattern\|Amiga Keyboard"
kbdpattern="$kbdpattern\|HIL keyboard"
kbdpattern="$kbdpattern\|ADB keyboard"
kbdpattern="$kbdpattern\|Sun Type"
if grep -i "$kbdpattern" /proc/bus/input/devices >/dev/null; then
return 0
fi
[ -d /sys/bus/usb/devices ] || return 0
for d in /sys/bus/usb/devices/*:*; do
class=$(cat "$d/bInterfaceClass") # 03 = Human Interface Device
subclass=$(cat "$d/bInterfaceSubClass") # 01 = Boot Interface Subclass
protocol=$(cat "$d/bInterfaceProtocol") # 01 = Keyboard
case "$class:$subclass:$protocol" in
03:01:01)
return 0
;;
esac
done
return 1
}
if type locale 2>/dev/null >/dev/null; then
eval `locale`
fi
if [ "$LC_CTYPE"  -a "$LC_CTYPE" != C ]; then
locale=$LC_CTYPE
elif db_get debian-installer/locale && [ "$RET" ]; then
locale="$RET"
else
locale=C
fi
if [ "$LC_MESSAGES"  -a "$LC_MESSAGES" != C ]; then
messages=$LC_MESSAGES
elif db_get debian-installer/locale && [ "$RET" ]; then
messages="$RET"
else
messages=C
fi
messages_lang=$(echo $messages | sed 's/_.*//')
messages_country=$(echo $messages | sed 's/.*_//;s/\..*//;s/@.*//')
messages_modif=
echo $messages | grep -v -q @ || messages_modif=$(echo $messages | sed 's/.*@//')
lang_kbdnames () {
all_kbdnames | \
regex_escape | \
grep "^$1[*]" | \
sed "s/^$1[*]//"
}
kbdnames=$(lang_kbdnames ${messages_lang}_${messages_country}__${messages_modif})
[ -n "$kbdnames" ] || kbdnames=$(lang_kbdnames ${messages_lang}_${messages_country}__${messages_modif})
[ -n "$kbdnames" ] || kbdnames=$(lang_kbdnames ${messages_lang}_${messages_country})
[ -n "$kbdnames" ] || kbdnames=$(lang_kbdnames ${messages_lang})
[ -n "$kbdnames" ] || kbdnames=$(lang_kbdnames C)
! type iconv >/dev/null || \
kbdnames="$(echo "$kbdnames" |
iconv -f UTF-8 -t $(locale charmap)//TRANSLIT)"
arch=`guess_arch`
case "$arch" in
alpha*)
XKBMODEL=pc105
model_priority=medium
;;
amd64*)
XKBMODEL=pc105
model_priority=medium
;;
arm*)
XKBMODEL=pc105
model_priority=medium
;;
i386*)
XKBMODEL=pc105
model_priority=medium
;;
hppa*)
XKBMODEL=pc105
model_priority=medium
;;
ia64*)
XKBMODEL=pc105
model_priority=medium
;;
m68k/amiga)
XKBMODEL=amiga
model_priority=medium
;;
m68k/atari)
XKBMODEL=ataritt
model_priority=medium
;;
m68k/mac)
XKBMODEL=macintosh_old
model_priority=medium
;;
m68k/sun*)
XKBMODEL=pc105 # UNKNOWN: sun4, sun5 or pc105
model_priority=critical
;;
m68k/*vme*)
XKBMODEL=pc105
model_priority=medium
;;
mips*)
XKBMODEL=pc105
model_priority=medium
;;
powerpc/amiga)
XKBMODEL=amiga
model_priority=medium
;;
powerpc/apus)
XKBMODEL=amiga
model_priority=medium
;;
powerpc/chrp*)
XKBMODEL=pc105 # UNKNOWN: pc105, macintosh_old or maybe amiga
model_priority=critical
;;
powerpc/mac)
XKBMODEL=pc105
model_priority=medium
;;
powerpc/pasemi)
XKBMODEL=pc105
model_priority=medium
;;
powerpc/powermac*)
XKBMODEL=pc105
model_priority=medium
;;
powerpc/prep)
XKBMODEL=pc105
model_priority=medium
;;
powerpc/ps3|powerpc/cell)
XKBMODEL=pc105
model_priority=medium
;;
sparc*)
XKBMODEL=pc105 # sun4 or sun5 on older kernels
model_priority=medium
;;
s390*)
XKBMODEL=pc105
model_priority=medium
;;
*)
XKBMODEL=pc105 # UNKNOWN
model_priority=critical
;;
esac    
layout_priority=critical
case "$locale" in
*_AL*)
XKBLAYOUT=al  # Albania
;;
*_AZ*)
XKBLAYOUT=az  # Azerbaijan
;;
*_BD*)
XKBLAYOUT=us,bd  # Bangladesh
;;
*_BE*)
XKBLAYOUT=be  # Belgium
;;
*_BG*)
XKBLAYOUT=us,bg  # Bulgaria
layout_priority=critical
;;
*_BR*)
XKBLAYOUT=br  # Brazil
;;
*_BT*)
XKBLAYOUT=us,bt  # Bhutan
;;
*_BY*)
XKBLAYOUT=us,by  # Belarus
;;
fr_CA*)
XKBLAYOUT=ca  # Canada
;;
*_CA*)
XKBLAYOUT=us  # U.S. English
;;
de_CH*)
XKBLAYOUT=ch  # Switzerland
;;
fr_CH*)
XKBLAYOUT=ch  # Switzerland
XKBVARIANT=fr # French
;;
*_CH*)
XKBLAYOUT=ch  # Switzerland
layout_priority=critical
;;
*_CZ*)
XKBLAYOUT=cz  # Czechia
layout_priority=critical
;;
*_DK*)
XKBLAYOUT=dk  # Denmark
;;
*_EE*)
XKBLAYOUT=ee  # Estonia
;;
ast_ES*)
XKBLAYOUT=es  # Spain
XKBVARIANT=ast # Asturian
;;
ca_ES*)
XKBLAYOUT=es  # Spain
XKBVARIANT=cat # Catalan
;;
*_ES*)
XKBLAYOUT=es  # Spain
;;
*_ET*)
XKBLAYOUT=us,et  # Ethiopia
;;
se_FI*)
XKBLAYOUT=fi  # Finland
XKBVARIANT=smi # Northern Saami
;;
*_FI*)
XKBLAYOUT=fi  # Finland
;;
*_FR*)
XKBLAYOUT=fr  # French
XKBVARIANT=latin9
;;
*_GB*)
XKBLAYOUT=gb  # United Kingdom
;;
*_GG*)
XKBLAYOUT=gb  # United Kingdom
;;
*_HU*)
XKBLAYOUT=hu  # Hungary
;;
*_IE*)
XKBLAYOUT=ie  # Ireland
;;
*_IL*)
XKBLAYOUT=us,il  # Israel
layout_priority=critical
;;
*_IM*)
XKBLAYOUT=gb  # United Kingdom
;;
*_IR*)
XKBLAYOUT=us,ir  # Iran
;;
*_IS*)
XKBLAYOUT=is  # Iceland
;;
*_IT*)
XKBLAYOUT=it  # Italy
;;
*_JE*)
XKBLAYOUT=gb  # United Kingdom
;;
*_JP*)
XKBLAYOUT=jp  # Japan
;;
*_LT*)
XKBLAYOUT=lt  # Lithuania
layout_priority=critical
;;
*_LV*)
XKBLAYOUT=lv  # Latvia
;;
*_KG*)
XKBLAYOUT=us,kg  # Kyrgyzstan
;;
*_KH*)
XKBLAYOUT=us,kh  # Cambodia
;;
*_KP*)
XKBLAYOUT=kr  # Korea
;;
*_KZ*)
XKBLAYOUT=us,kz  # Kazakhstan
;;
*_LK*)
XKBLAYOUT=us,lk  # Sri Lanka
;;
*_MA*)
XKBLAYOUT=us,ma  # Morocco
;;
*_MK*)
XKBLAYOUT=us,mk  # Macedonia
;;
*_NL*)
XKBLAYOUT=us  # Netherlands
;;
*_MN*)
XKBLAYOUT=us,mn  # Mongolia
;;
*_MT*)
XKBLAYOUT=mt  # Malta
layout_priority=critical
;;
se_NO*)
XKBLAYOUT=no  # Norway
XKBVARIANT=smi # Northern Saami
;;
*_NO*)
XKBLAYOUT=no  # Norway (se_NO is not in this case)
;;
*_NP*)
XKBLAYOUT=us,np  # Nepal
;;
*_PL*)
XKBLAYOUT=pl  # Poland
;;
*_PT*)
XKBLAYOUT=pt  # Portugal
;;
*_RO*)
XKBLAYOUT=ro  # Romania
;;
*_RU*)
XKBLAYOUT=us,ru  # Russia
layout_priority=critical
;;
se_SE*)
XKBLAYOUT=se  # Sweden
XKBVARIANT=smi # Northern Saami
;;
*_SK*)
XKBLAYOUT=sk  # Slovakia
;;
*_SI*)
XKBLAYOUT=si  # Slovenia
;;
*_TJ*)
XKBLAYOUT=us,tj  # Tajikistan
;;
*_TH*)
XKBLAYOUT=us,th  # Thailand
layout_priority=critical
;;
*_TR*)
XKBLAYOUT=tr  # Turkish
layout_priority=critical
;;
*_UA*)
XKBLAYOUT=us,ua  # Ukraine
;;
en_US*)
XKBLAYOUT=us  # U.S. English
;;
*_VN*)
XKBLAYOUT=vn  # Vietnam
;;
*_ZA*)
XKBLAYOUT=za  # South Africa
;;
*_AR*|*_BO*|*_CL*|*_CO*|*_CR*|*_DO*|*_EC*|*_GT*|*_HN*|*_MX*|*_NI*|*_PA*|*_PE*|es_PR*|*_PY*|*_SV*|es_US*|*_UY*|*_VE*)
XKBLAYOUT=latam # Latin American
;;
ar_*)
XKBLAYOUT=us,ara # Arabic
;;
bn_*)
XKBLAYOUT=us,in  # India
XKBVARIANT=,ben # Bengali
;;
bs_*)
XKBLAYOUT=ba  # Bosnia and Herzegovina
;;
de_LI*)
XKBLAYOUT=ch  # Liechtenstein
;;
de_*)
XKBLAYOUT=de  # Germany
;;
el_*)
XKBLAYOUT=us,gr  # Greece
;;
eo|eo.*|eo_*|eo\@*)
XKBLAYOUT=epo  # Esperanto
layout_priority=critical
;;
fr_*)
XKBLAYOUT=fr  # France
XKBVARIANT=latin9
layout_priority=critical
;;
gu_*)
XKBLAYOUT=us,in  # India
XKBVARIANT=,guj # Gujarati
;;
hi_*)
XKBLAYOUT=us,in  # India
XKBVARIANT=,deva # Devanagari
;;
hr_*)
XKBLAYOUT=hr  # Croatia
;;
hy_*)
XKBLAYOUT=us,am  # Armenia
;;
ka_*)
XKBLAYOUT=us,ge  # Georgia
layout_priority=critical
;;
kn_*)
XKBLAYOUT=us,in  # India
XKBVARIANT=,kan # Kannada
;;
ku_*)
XKBLAYOUT=tr  # Turkish
XKBVARIANT=ku # Kurdish
layout_priority=critical
;;
lo_*)
XKBLAYOUT=us,la  # Laos
;;
ml_*)
XKBLAYOUT=us,in  # India
XKBVARIANT=,mal # Malayalam
;;
os_*)
XKBLAYOUT=ru  # Russia
XKBVARIANT=os  # Ossetian
;;
pa_*)
XKBLAYOUT=us,in  # India
XKBVARIANT=,guru # Gurmukhi
;;
si_*)
XKBLAYOUT=us,si  # Sri Lanka
XKBVARIANT=,sin_phonetic # Sinhala
;;
sr_*)
XKBLAYOUT=cs,cs  # Serbia and Montenegro
XKBVARIANT=latin,basic
layout_priority=critical
;;
sv_*)
XKBLAYOUT=se  # Sweden
;;
ta_*)
XKBLAYOUT=us,in  # India
XKBVARIANT=,tam # Tamil
;;
te_*)
XKBLAYOUT=us,in  # India
XKBVARIANT=,tel # Telugu
;;
ug_*)
XKBLAYOUT=us,cn  # China
XKBVARIANT=,uig # Uyghur
;;
zh_*)
XKBLAYOUT=cn  # Chinese
;;
*)
XKBLAYOUT=us
;;
esac
if db_get keyboard-configuration/modelcode && [ "$RET" ]; then
XKBMODEL="$RET"
fi
if db_get keyboard-configuration/layoutcode && [ "$RET" ]; then
XKBLAYOUT="$RET"
fi
if db_get keyboard-configuration/variantcode && [ "$RET" ]; then
XKBVARIANT="$RET"
fi
if db_get keyboard-configuration/optionscode && [ "$RET" ]; then
XKBOPTIONS="$RET"
fi
if db_get debian-installer/keymap && [ "$RET" ]; then
di_keymap="${RET##mac-usb-}"
di_keymap="${di_keymap%%-latin1}"
old_xkbvariant="$XKBVARIANT"
XKBVARIANT=''
old_layout_priority=$layout_priority
layout_priority=medium
case "$di_keymap" in
be2) XKBLAYOUT="be";;
bg) XKBLAYOUT="us,bg";;
br) XKBLAYOUT="us"; XKBVARIANT="intl";;
br-abnt2) XKBLAYOUT="br"; XKBVARIANT="abnt2";;
by) XKBLAYOUT="us,by";;
cf) XKBLAYOUT="ca"; XKBVARIANT="fr";;
croat) XKBLAYOUT="hr";;
cz-lat2) XKBLAYOUT="cz";;
de-latin1-nodeadkeys) XKBLAYOUT="de"; XKBVARIANT="nodeadkeys";;
de) XKBLAYOUT="de";;
dvorak) XKBLAYOUT="us"; XKBVARIANT="dvorak";;
dk) XKBLAYOUT="dk";;
es) XKBLAYOUT="es";;
et) XKBLAYOUT="ee";;
'fi') XKBLAYOUT="fi";;
fr-latin9) XKBLAYOUT="fr"; XKBVARIANT="latin9";;
fr_CH) XKBLAYOUT="ch"; XKBVARIANT="fr";;
fr) XKBLAYOUT="fr";;
hebrew) XKBLAYOUT="us,il";;
hu) XKBLAYOUT="hu";;
gb) XKBLAYOUT="gb";;
is) XKBLAYOUT="is";;
it) XKBLAYOUT="it";;
jp106) XKBLAYOUT="jp"; XKBVARIANT="106";;
la) XKBLAYOUT="latam";;
lt) XKBLAYOUT="lt";; 
lv-latin4) XKBLAYOUT="lv";;
mac-us-std) XKBLAYOUT="us";;
mac-de2-ext) XKBLAYOUT="de"; XKBVARIANT="nodeadkeys";;
mac-fr2-ext) XKBLAYOUT="fr";;
mac-fr3) XKBLAYOUT="fr";;
mac-es) XKBLAYOUT="es";;
ky) XKBLAYOUT="us,kg";;
mk) XKBLAYOUT="us,mk";;
nl) XKBLAYOUT="nl";;
no) XKBLAYOUT="no";;
pl) XKBLAYOUT="pl";;
pt) XKBLAYOUT="pt";;
ro) XKBLAYOUT="ro";;
ru) XKBLAYOUT="us,ru";;
se) XKBLAYOUT="se";;
sg) XKBLAYOUT="ch"; XKBVARIANT="de";;
sk-qwerty) XKBLAYOUT="sk"; XKBVARIANT="qwerty";;
slovene) XKBLAYOUT="si";;
sr-cy) XKBLAYOUT="cs,cs"; XKBVARIANT="latin,basic" ;;
trf|trfu) XKBLAYOUT="tr"; XKBVARIANT="f";;
trq|trqu) XKBLAYOUT="tr";;
ua) XKBLAYOUT="us,ua";;
uk) XKBLAYOUT="gb";;
us) XKBLAYOUT="us";;
*) 
XKBVARIANT="$old_xkbvariant"
layout_priority=$old_layout_priority
;;
esac
fi
if \
[ -f /etc/X11/xorg.conf -a ! -e $CONFIGFILE ] \
&& type awk 2>/dev/null >/dev/null
then
awk_expr='
{
sub("#.*","")
line = $0;
$0 = tolower($0);
xkb = "";
}
/^[ \t]*section[ \t]+"inputdevice"/,/^[ \t]*endsection/ {
if ($1 == "option") {
if ($2 == "\"xkbmodel\"") {
xkb = "XKBMODEL";
} else if ($2 == "\"xkblayout\"") {
xkb = "XKBLAYOUT";
print "layout_priority=medium";
} else if ($2 == "\"xkbvariant\"") {
xkb = "XKBVARIANT";
} else if ($2 == "\"xkboptions\"") {
xkb = "XKBOPTIONS"; 
}
$0 = line;
$1 = "";
$2 = "";
}
}
xkb != "" && /^[ \t]*\"[^"]+\"[ \t]*$/ {
sub("^[ \t]*\"", "");
sub("\".*", "");
gsub("[ \t]", "");
if ($1 !~ /[()]/) {
print xkb "=\"" $0 "\"";
} else {
if (xkb == "XKBLAYOUT" && $1 ~ /^[^()]+\([^()]+\)$/) {
l=$1;                      # us(intl),cz(qwerty)
gsub(/\([^()]*\)/,"",l);   # us,cz
v=$1;                      # us(intl),cz(qwerty)     us,bg
gsub(/\)/,"",v);           # us(intl,cz(qwerty       us,bg
gsub(/^[^(,]*,/,",",v);    # us(intl,cz(qwerty       ,bg
gsub(/^[^(,]*$/,"",v);     # us(intl,cz(qwerty       ,bg
gsub(/^[^(,]*\(/,"",v);    # intl,cz(qwerty          ,bg
gsub(/,[^(,]*,/,",,",v);   # intl,cz(qwerty          ,bg
gsub(/,[^(,]*$/,",",v);    # intl,cz(qwerty          ,
gsub(/,[^(,]*\(/,",",v);   # intl,qwerty             ,
print "XKBLAYOUT=" l;
print "XKBVARIANT=" v;
}
}
}
'
eval $(awk "$awk_expr" < /etc/X11/xorg.conf)
fi
if [ -e $OLDCONFIGFILE ]; then
. $OLDCONFIGFILE || true
fi
if [ -e $CONFIGFILE ]; then
. $CONFIGFILE || true
fi
XKBMODEL=$(echo $XKBMODEL | sed 's/ *//g')
XKBLAYOUT=$(echo $XKBLAYOUT | sed 's/ *//g')
XKBVARIANT=$(echo $XKBVARIANT | sed 's/ *//g')
if [ "$XKBLAYOUT" ]; then
case "$XKBLAYOUT" in
lt,lt)
default_layout="${XKBLAYOUT%,*}"
default_variant="${XKBVARIANT%,*}"
unsupported_layout=no
;;
jp,jp|us,jp)
default_layout="${XKBLAYOUT#*,}"
default_variant="${XKBVARIANT#*,}"
unsupported_layout=no
;;
cs,cs|us,am|us,af|us,ara|us,ben|us,bd|us,bg|us,bt|us,by|us,deva|us,et|us,ge|us,gh|us,gr|us,guj|us,guru|us,il|us,in|us,ir|us,iku|us,iq|us,ir|us,kan|us,kh|us,kz|us,la|us,lao|us,lk|us,lt|us,kg|us,ma|us,mal|us,mk|us,mm|us,mn|us,mv|us,np|us,ori|us,pk|us,ru|us,scc|us,sy|us,syr|us,tel|us,th|us,tj|us,tam|us,ua|us,uig|us,uz)
if [ "${XKBVARIANT%,*}" = '' ]; then
default_layout="${XKBLAYOUT#*,}"
default_variant="${XKBVARIANT#*,}"
unsupported_layout=no
else
unsupported_layout=yes
fi
;;	    
*,*)
unsupported_layout=yes
;;
*)
default_layout="$XKBLAYOUT"
default_variant="$XKBVARIANT"
;;
esac
fi
if \
! echo "$kbdnames" \
| grep "variant[*]$default_layout[*]$default_variant[*]" >/dev/null
then
unsupported_layout=yes
default_variant=''
if \
! echo "$kbdnames" \
| grep "layout[*]$default_layout[*]" >/dev/null
then
default_layout=us
fi
fi
if [ "$default_layout" = bg -a -z "$default_variant" ]; then
default_variant=bds
[ "$layout_priority" = critical ] || layout_priority=high
fi
default_toggle='Alt+Shift'
default_switch='No temporary switch'
default_altgr='The default for the keyboard layout'
default_compose='No compose key'
default_ctrl_alt_bksp=false
if [ "$XKBOPTIONS" ]; then
default_toggle='No toggling'
default_switch='No temporary switch'
default_altgr='The default for the keyboard layout'
default_compose='No compose key'
for option in `echo $XKBOPTIONS | sed 's/,/ /g'`; do
case "$option" in
compose:caps)
default_compose='Caps Lock';;
compose:lwin)
default_compose='Left Logo key';;
compose:menu)
default_compose='Menu key';;
compose:ralt)
default_compose='Right Alt (AltGr)';;
compose:rctrl)
default_compose='Right Control';;
compose:rwin)
default_compose='Right Logo key';;
grp:alt_caps_toggle)
default_toggle='Alt+Caps Lock';;
grp:alt_shift_toggle)
default_toggle='Alt+Shift';;
grp:caps_toggle)
default_toggle='Caps Lock';;
grp:ctrl_alt_toggle)
default_toggle='Control+Alt';;
grp:ctrl_shift_toggle)
default_toggle='Control+Shift';;
grp:lalt_toggle)
default_toggle='Left Alt';;
grp:lctrl_lshift_toggle)
default_toggle='Left Control+Left Shift';;
grp:lctrl_toggle)
default_toggle='Left Control';;
grp:lshift_toggle)
default_toggle='Left Shift';;
grp:lswitch)
default_switch='Left Alt';;
grp:lwin_switch)
default_switch='Left Logo key';;
grp:lwin_toggle)
default_toggle='Left Logo key';;
grp:menu_toggle)
default_toggle='Menu key';;
grp:rctrl_toggle)
default_toggle='Right Control';;
grp:rshift_toggle)
default_toggle='Right Shift';;
grp:rwin_switch)
default_switch='Right Logo key';;
grp:rwin_toggle)
default_toggle='Right Logo key';;
grp:sclk_toggle)
default_toggle='Scroll Lock key';;
grp:switch)
default_switch='Right Alt (AltGr)';;
grp:toggle)
default_toggle='Right Alt (AltGr)';;
grp:win_switch)
default_switch='Both Logo keys';;
lv3:ralt_alt)
default_altgr='No AltGr key';;
lv3:alt_switch)
default_altgr='Both Alt keys';;
lv3:enter_switch)
default_altgr='Keypad Enter key';;
lv3:lalt_switch)
default_altgr='Left Alt';;
lv3:lwin_switch)
default_altgr='Left Logo key';;
lv3:menu_switch)
default_altgr='Menu key';;
lv3:ralt_switch)
default_altgr='Right Alt (AltGr)';;
lv3:rwin_switch)
default_altgr='Right Logo key';;
lv3:switch)
default_altgr='Right Control';;
lv3:win_switch)
default_altgr='Both Logo keys';;
terminate:ctrl_alt_bksp)
default_ctrl_alt_bksp=true;;
grp_led:scroll)
;;
*)
unsupported_options=yes
;;
esac
done
fi
db_default keyboard-configuration/toggle "$default_toggle"
db_default keyboard-configuration/switch "$default_switch"
db_default keyboard-configuration/altgr "$default_altgr"
db_default keyboard-configuration/compose "$default_compose"
db_default keyboard-configuration/ctrl_alt_bksp "$default_ctrl_alt_bksp"
if [ ! "$unsupported_layout" = yes ]
then
if [ -n "$default_variant" ]
then
default_keymap="$default_layout($default_variant)"
else
default_keymap="$default_layout"
fi
fi
db_default keyboard-configuration/xkb-keymap "$default_keymap"
initial_xkbmodel="$XKBMODEL"
if [ -z "$XKBMODEL" ]; then
model_priority=critical
XKBMODEL=pc105
db_fset keyboard-configuration/model seen false
fi
if [ -z "$XKBLAYOUT" ]; then
layout_priority=critical
unsupported_layout=no
XKBLAYOUT=us
default_layout=us
db_fset keyboard-configuration/layout seen false
db_fset keyboard-configuration/variant seen false
fi
if ! keyboard_present; then
db_set keyboard-configuration/modelcode "$XKBMODEL"
db_set keyboard-configuration/layoutcode "$XKBLAYOUT"
db_set keyboard-configuration/variantcode "$XKBVARIANT"
if [ -z "$XKBOPTIONS" -a ! -f $CONFIGFILE ]; then
case "$XKBLAYOUT" in
*,*) XKBOPTIONS="grp:alt_shift_toggle,grp_led:scroll";;
us) XKBOPTIONS="";;
*) XKBOPTIONS="lv3:ralt_switch";;
esac
fi
db_set keyboard-configuration/optionscode "$XKBOPTIONS"
exit 0
fi
STATE=1
old_state=0
while :; do
starting_state=$STATE
case "$STATE" in
1)
if [ "$is_debian_installer" ]; then
db_set keyboard-configuration/modelcode "$XKBMODEL"
db_fset keyboard-configuration/model seen true
STATE=$(( $STATE + $STATE - $old_state ))
else
if [ "$XKBMODEL" = unknown ]; then
model_priority=critical
db_fset keyboard-configuration/model seen false
fi
if \
ask_debconf keyboard-configuration/model $model_priority \
model "$XKBMODEL"
then
XKBMODEL="$RET"
db_set keyboard-configuration/modelcode "$RET"
STATE=$(($STATE + 1))
else
STATE=$(($STATE - 1))
fi
fi
;;
2)
if \
[ "$unsupported_layout" = yes -a "$is_not_debian_installer" ]
then
case "$XKBVARIANT" in
,|,,|,,,|'')
unsupported_variant=''
;;
*)
unsupported_variant="/$XKBVARIANT"
;;
esac
if [ -f $CONFIGFILE ]; then
db_subst keyboard-configuration/unsupported_config_layout \
XKBLAYOUT "$XKBLAYOUT"
db_subst keyboard-configuration/unsupported_config_layout \
XKBVARIANT "$XKBVARIANT"
db_input medium keyboard-configuration/unsupported_config_layout \
|| true
if db_go; then 
STATE=$(($STATE + 1))
else
STATE=$(($STATE - 1))
fi
db_get keyboard-configuration/unsupported_config_layout
else
db_subst keyboard-configuration/unsupported_layout \
XKBLAYOUT "$XKBLAYOUT"
db_subst keyboard-configuration/unsupported_layout \
XKBVARIANT "$XKBVARIANT"
db_subst keyboard-configuration/unsupported_layout \
XKBLAYOUTVARIANT "$XKBLAYOUT$unsupported_variant"
db_input medium keyboard-configuration/unsupported_layout || true
if db_go; then 
STATE=$(($STATE + 1))
else
STATE=$(($STATE - 1))
fi
db_get keyboard-configuration/unsupported_layout
fi
if [ "$RET" != true ]; then
unsupported_layout=no
fi
else
db_reset keyboard-configuration/unsupported_config_layout || true
db_fset keyboard-configuration/unsupported_config_layout seen false
db_reset keyboard-configuration/unsupported_layout || true
db_fset keyboard-configuration/unsupported_layout seen false
STATE=$(( $STATE + $STATE - $old_state ))
fi
;;
3)
if [ "$is_debian_installer" ]; then
db_input critical keyboard-configuration/xkb-keymap || true
if db_go; then 
STATE=$(($STATE + 1))
else
STATE=$(($STATE - 1))
fi
db_get keyboard-configuration/xkb-keymap
keymap="$RET"
layout="${keymap%(*}"
variant="${keymap#$layout}"
variant="${variant%)}"
variant="${variant#(}"
default_layout="$layout"
default_variant="$variant"
db_fset keyboard-configuration/layout seen true
db_fset keyboard-configuration/variant seen true
elif \
[ "$unsupported_layout" = yes -o "$default_variant" != other ]
then
layout="$default_layout"
db_set keyboard-configuration/layoutcode "$XKBLAYOUT"
STATE=$(( $STATE + $STATE - $old_state ))
elif \
ask_debconf keyboard-configuration/layout "$layout_priority" \
layout "$default_layout"
then
default_layout="$RET"
layout="$RET"
STATE=$(($STATE + 1)) 
else
STATE=$(($STATE + 1))
fi
;;
4)
db_metaget keyboard-configuration/other description
other="$RET"
if [ "$unsupported_layout" = yes ]; then
variant=none
case "$XKBLAYOUT" in
*,*)
latin=no
;;
*)
latin=yes
;;
esac
db_set keyboard-configuration/variantcode "$XKBVARIANT"
STATE=$(( $STATE + $STATE - $old_state ))
elif [ "$is_not_debian_installer" ]; then
if \
! ask_debconf keyboard-configuration/variant \
"$layout_priority" \
"variant*${layout}" "$default_variant" \
"variant*${layout}*other*$other"
then
variant=none
starting_state=$(($STATE - 1))
STATE=$(($STATE - 2))
elif [ "$RET" = other ]; then
variant=none
default_variant="$RET"
STATE=$(($STATE - 1))
else
variant="$RET"
default_variant="$RET"
fi
fi
if [ "$variant" != none ]; then
case "$layout" in
cs)
case "$variant" in
latin*)
latin=yes
XKBLAYOUT=$layout
;;
*)
latin=no
XKBLAYOUT=cs,cs
;;
esac
;;
jp)
case "$variant" in
106|common|OADG109A|'')
latin=yes
XKBLAYOUT=$layout
;;
*)
latin=no
XKBLAYOUT=jp,jp
;;
esac
;;
lt)
latin=no
XKBLAYOUT=lt,lt
;;
af|am|ara|ben|bd|bg|bt|by|deva|et|ge|gh|gr|guj|guru|il|in|iq|ir|iku|kan|kh|kz|la|lao|lk|kg|ma|mk|mm|mn|mv|mal|np|ori|pk|ru|scc|sy|syr|tel|th|tj|tam|ua|uig|uz)
latin=no
XKBLAYOUT=us,$layout
;;
*)
latin=yes
XKBLAYOUT=$layout
;;
esac
db_set keyboard-configuration/layoutcode "$XKBLAYOUT"
if [ "$latin" = yes ]; then
db_set keyboard-configuration/variantcode "$variant"
elif [ "$XKBLAYOUT" = cs,cs ]; then
case "$variant" in
yz)
db_set keyboard-configuration/variantcode \
"latinyz,$variant"
;;
alternatequotes)
db_set keyboard-configuration/variantcode \
"latinalternatequotes,$variant"
;;
*)
db_set keyboard-configuration/variantcode \
"latin,$variant"
;;
esac
elif [ "$XKBLAYOUT" = lt,lt ]; then
case "$variant" in
us)
db_set keyboard-configuration/variantcode "us,"
;;
*)
db_set keyboard-configuration/variantcode "$variant,us"
;;
esac
else
db_set keyboard-configuration/variantcode ",$variant"
fi
STATE=$(($STATE + 1))
fi
;;
5)
if \
[ "$unsupported_options" = yes -a "$is_not_debian_installer" ]
then
if [ -f $CONFIGFILE ]; then
db_subst keyboard-configuration/unsupported_config_options \
XKBOPTIONS "$XKBOPTIONS"
db_input medium keyboard-configuration/unsupported_config_options \
|| true
if db_go; then 
STATE=$(($STATE + 1))
else
STATE=$(($STATE - 1))
fi
db_get keyboard-configuration/unsupported_config_options
else
db_subst keyboard-configuration/unsupported_options \
XKBOPTIONS "$XKBOPTIONS"
db_input medium keyboard-configuration/unsupported_options || true
if db_go; then 
STATE=$(($STATE + 1))
else
STATE=$(($STATE - 1))
fi
db_get keyboard-configuration/unsupported_options
fi
if [ "$RET" != true ]; then
unsupported_options=no
fi
else
db_reset keyboard-configuration/unsupported_config_options || true
db_fset keyboard-configuration/unsupported_config_options seen false
db_reset keyboard-configuration/unsupported_options || true
db_fset keyboard-configuration/unsupported_options seen false
STATE=$(( $STATE + $STATE - $old_state ))
fi
;;
6)
if [ "$unsupported_options" = yes ]; then
db_set keyboard-configuration/optionscode "$XKBOPTIONS"
STATE=$(( $STATE + $STATE - $old_state ))
else
caps_allocated=no
lalt_allocated=no
lctrl_allocated=no
lshift_allocated=no
lwin_allocated=no
menu_allocated=no
ralt_allocated=no
rctrl_allocated=no
rshift_allocated=no
rwin_allocated=no
if [ "$latin" = yes ]; then
db_set keyboard-configuration/toggle 'No toggling'
db_set keyboard-configuration/switch 'No temporary switch'
fi
db_beginblock
if [ "$latin" = no ]; then
db_input high keyboard-configuration/toggle || true
if [ "$is_not_debian_installer" ]; then
db_input medium keyboard-configuration/switch || true
fi
fi
if [ "$is_not_debian_installer" ]; then
db_input medium keyboard-configuration/altgr || true
db_input medium keyboard-configuration/compose || true
fi
if [ -f /usr/bin/X ]; then
db_input medium keyboard-configuration/ctrl_alt_bksp || true
fi
db_endblock
if db_go; then 
STATE=$(($STATE + 1))
else
STATE=$(($STATE - 1))
fi
db_get keyboard-configuration/toggle
case "$RET" in
Caps\ Lock)
caps_allocated=yes
toggle=caps_toggle;;
Right\ Alt*)
ralt_allocated=yes
toggle=toggle;;
Right\ Control)
rctrl_allocated=yes
toggle=rctrl_toggle;;
Right\ Shift)
rshift_allocated=yes
toggle=rshift_toggle;;
Right\ Logo?key)
rwin_allocated=yes
toggle=rwin_toggle;;
Menu?key)
menu_allocated=yes
toggle=menu_toggle;;
Alt+Shift)
toggle=alt_shift_toggle;;
Control+Shift)
toggle=ctrl_shift_toggle;;
Left\ Control+Left\ Shift)
toggle=lctrl_lshift_toggle;;
Scroll\ Lock\ key)
toggle=sclk_toggle;;
Alt+Caps\ Lock)
toggle=alt_caps_toggle;;
Control+Alt)
toggle=ctrl_alt_toggle;;
Left\ Alt)
lalt_allocated=yes
toggle=lalt_toggle;;
Left\ Control)
lctrl_allocated=yes
toggle=lctrl_toggle;;
Left\ Shift)
lshift_allocated=yes
toggle=lshift_toggle;;
Left\ Logo?key)
lwin_allocated=yes
toggle=lwin_toggle;;
No\ toggling)
toggle='';;
*)
echo Unknown toggle key option
exit 1
;;
esac
if [ "$toggle" ]; then
toggle=grp:$toggle
fi
db_get keyboard-configuration/switch
switch=''
case "$RET" in
Right\ Alt*)
if [ "$ralt_allocated" != yes ]; then
switch=switch
ralt_allocated=yes
fi;;
Left\ Alt)
if [ "$lalt_allocated" != yes ]; then
switch=lswitch
lalt_allocated=yes
fi;;
Right\ Logo?key)
if [ "$rwin_allocated" != yes ]; then
switch=rwin_switch
rwin_allocated=yes
fi;;
Left\ Logo?key)
if [ "$lwin_allocated" != yes ]; then
switch=lwin_switch
lwin_allocated=yes
fi;;
Both\ Logo?keys)
if \
[ "$rwin_allocated" != yes ] \
&& [ "$lwin_allocated" != yes ]
then
switch=win_switch
rwin_allocated=yes
lwin_allocated=yes
fi;;
No\ temporary\ switch)
switch='';;
*)
echo Unknown switch key option
exit 1
;;
esac
if [ "$switch" ]; then
switch=grp:$switch
fi
db_get keyboard-configuration/altgr
altgr=''
case "$RET" in
The?default?for?the?keyboard?layout)
altgr='';;
No?AltGr?key)
if [ "$ralt_allocated" != yes ]; then
altgr=ralt_alt
fi;;
Right?Alt*)
if [ "$ralt_allocated" != yes ]; then
altgr=ralt_switch
ralt_allocated=yes
fi;;
Right?Control)
if [ "$rctrl_allocated" != yes ]; then
altgr=switch
rctrl_allocated=yes
fi;;
Menu?key)
if [ "$menu_allocated" != yes ]; then
altgr=menu_switch
menu_allocated=yes
fi;;
Keypad?Enter?key)
altgr=enter_switch;;
Right?Logo?key)
if [ "$rwin_allocated" != yes ]; then
altgr=rwin_switch
rwin_allocated=yes
fi;;
Left?Logo?key)
if [ "$lwin_allocated" != yes ]; then
altgr=lwin_switch
lwin_allocated=yes
fi;;
Both?Logo?keys)
if \
[ "$rwin_allocated" != yes ] \
&& [ "$lwin_allocated" != yes ]
then
altgr=win_switch
rwin_allocated=yes
lwin_allocated=yes
fi;;
Both?Alt?keys)
if \
[ "$lalt_allocated" != yes ] \
&& [ "$ralt_allocated" != yes ]
then
altgr=alt_switch
ralt_allocated=yes
lalt_allocated=yes
fi;;
Left?Alt)
if [ "$lalt_allocated" != yes ]; then
altgr=lalt_switch
lalt_allocated=yes
fi;;
*)
echo Unknown altgr key option
exit 1
;;
esac
if [ "$altgr" ]; then
altgr=lv3:$altgr
fi
db_get keyboard-configuration/compose
compose=''
case "$RET" in
No?compose?key)
compose='';;
Right?Alt*)
if [ "$ralt_allocated" != yes ]; then
compose=ralt
ralt_allocated=yes
fi;;
Right?Logo?key)
if [ "$rwin_allocated" != yes ]; then
compose=rwin
rwin_allocated=yes
fi;;
Left?Logo?key)
if [ "$lwin_allocated" != yes ]; then
compose=lwin 
lwin_allocated=yes
fi;;
Right?Control)
if [ "$rctrl_allocated" != yes ]; then
compose=rctrl 
rctrl_allocated=yes
fi;;
Menu?key)
if [ "$menu_allocated" != yes ]; then
compose=menu
menu_allocated=yes
fi;;
Caps?Lock)
if [ "$caps_allocated" != yes ]; then
compose=caps
caps_allocated=yes
fi;;
*)
echo Unknown compose key option
exit 1
;;
esac
if [ "$compose" ]; then
compose=compose:$compose
fi
db_get keyboard-configuration/ctrl_alt_bksp
if [ "$RET" = true ]; then
terminate=terminate:ctrl_alt_bksp
else
terminate=''
fi
if [ "$ralt_allocated" = yes -a "$altgr" = lv3:ralt_alt ]; then
altgr=''
fi
case "$XKBLAYOUT" in
*,*)
leds=grp_led:scroll;;
*)
leds='';;
esac
options=$(
echo $toggle $switch $altgr $compose $terminate $leds \
| sed -e 's/^ *//' -e 's/ *$//' -e 's/  */,/g'
)
db_set keyboard-configuration/optionscode "$options"
fi
;;
*)
break
;;
esac
old_state=$starting_state
done
if [ $STATE -eq 0 ]; then
exit 10
else
db_set keyboard-configuration/store_defaults_in_debconf_db false
fi
exit 0
